--------------------------------------------------
CREATE TABLES
--------------------------------------------------
CREATE TABLE AvaliacaoUtilizador (username varchar2(50) NOT NULL, idReceita number(7) NOT NULL, valor number(10) NOT NULL, PRIMARY KEY (username, idReceita));
CREATE TABLE ChefesSeguidos (username varchar2(50) NOT NULL, chefeseguido varchar2(50) NOT NULL, PRIMARY KEY (username, chefeseguido));
CREATE TABLE ReceitasProprias (username varchar2(50) NOT NULL, idReceita number(7) NOT NULL, PRIMARY KEY (username, idReceita));
CREATE TABLE Comentarios (idComentario number(7) NOT NULL, idReceita number(7) NOT NULL, username varchar2(50) NOT NULL, comentario varchar2(300) NOT NULL, apagado number(1) DEFAULT '0', created_at date NOT NULL, updated_at date NOT NULL, PRIMARY KEY (idComentario));
CREATE TABLE ReceitasSeguidas (username varchar2(50) NOT NULL, idReceita number(7) NOT NULL, PRIMARY KEY (username, idReceita));
CREATE TABLE Categorias (nomeCategoria varchar2(50) NOT NULL, apagado number(1) DEFAULT '0', PRIMARY KEY (nomeCategoria));
CREATE TABLE Imagens (idImagem number(7) NOT NULL, idReceita number(7) NOT NULL, imagem varchar2(100) DEFAULT '/assets/images/uploads/default.png' NOT NULL, PRIMARY KEY (idImagem));
CREATE TABLE Receitas (idReceita number(7) NOT NULL, nome varchar2(100) NOT NULL, descricao varchar2(500) NOT NULL, nrImagens number(4) NOT NULL, categoria varchar2(50) NOT NULL, username varchar2(50) NOT NULL, valorAvaliacoes number(4) DEFAULT 0, nrAvaliacoes number(4) NOT NULL, custo number(10) DEFAULT 0, apagado number(1) DEFAULT '0' NOT NULL, tempoPreparacao number(10) DEFAULT 0, dose number(10) DEFAULT 0, created_at date NOT NULL, updated_at date NOT NULL, ingredientes varchar2(300) NOT NULL, vNutricional number(10) DEFAULT 0, PRIMARY KEY (idReceita));
CREATE TABLE Utilizadores (username varchar2(50) NOT NULL, nome varchar2(200) NOT NULL, email varchar2(70) NOT NULL UNIQUE, password varchar2(100) NOT NULL, avatar varchar2(100) DEFAULT '/assets/images/Users/avatar.png', descricao varchar2(300) DEFAULT 'Eu', nrReceitas number(4) DEFAULT 0, valorAvaliacoes number(4) DEFAULT 0, nrAvaliacoes number(4) DEFAULT 0, dadosCompletos number(1) DEFAULT '0', apagado number(1) DEFAULT '0', tipo number(10) NOT NULL, created_at date NOT NULL, updated_at date NOT NULL, localidade varchar2(100) DEFAULT 'Localidade', PRIMARY KEY (username));


ALTER TABLE ChefesSeguidos ADD CONSTRAINT FKChefesSegu38100 FOREIGN KEY (chefeseguido) REFERENCES Utilizadores (username);
ALTER TABLE ChefesSeguidos ADD CONSTRAINT FKChefesSegu977313 FOREIGN KEY (username) REFERENCES Utilizadores (username);
ALTER TABLE AvaliacaoUtilizador ADD CONSTRAINT FKAvaliacaoU192827 FOREIGN KEY (username) REFERENCES Utilizadores (username);
ALTER TABLE AvaliacaoUtilizador ADD CONSTRAINT FKAvaliacaoU614305 FOREIGN KEY (idReceita) REFERENCES Receitas (idReceita);
ALTER TABLE ReceitasProprias ADD CONSTRAINT FKReceitasPr675622 FOREIGN KEY (idReceita) REFERENCES Receitas (idReceita);
ALTER TABLE ReceitasProprias ADD CONSTRAINT FKReceitasPr254144 FOREIGN KEY (username) REFERENCES Utilizadores (username);
ALTER TABLE ReceitasSeguidas ADD CONSTRAINT FKReceitasSe455650 FOREIGN KEY (idReceita) REFERENCES Receitas (idReceita);
ALTER TABLE ReceitasSeguidas ADD CONSTRAINT FKReceitasSe877128 FOREIGN KEY (username) REFERENCES Utilizadores (username);
ALTER TABLE Comentarios ADD CONSTRAINT FKComentario759033 FOREIGN KEY (username) REFERENCES Utilizadores (username);
ALTER TABLE Comentarios ADD CONSTRAINT FKComentario791078 FOREIGN KEY (idReceita) REFERENCES Receitas (idReceita);
ALTER TABLE Imagens ADD CONSTRAINT FKImagens137172 FOREIGN KEY (idReceita) REFERENCES Receitas (idReceita);
ALTER TABLE Receitas ADD CONSTRAINT FKReceitas116308 FOREIGN KEY (categoria) REFERENCES Categorias (nomeCategoria);
ALTER TABLE Receitas ADD CONSTRAINT FKReceitas413557 FOREIGN KEY (username) REFERENCES Utilizadores (username);


--------------------------------------------------
VIEWS
--------------------------------------------------
CREATE OR REPLACE
VIEW v_usersRecentes AS
SELECT * FROM UTILIZADORES WHERE APAGADO=0
ORDER BY CREATED_AT DESC;

CREATE OR REPLACE
VIEW v_receitasRecentes AS
SELECT * FROM RECEITAS WHERE APAGADO=0
ORDER BY CREATED_AT DESC;

CREATE OR REPLACE
VIEW v_receitasMelhorAvaliada AS
SELECT IDRECEITA, NOME FROM RECEITAS WHERE F_MEDIAAVALIACAO(IDRECEITA)>0;
ORDER BY F_MEDIAAVALIACAO(IDRECEITA) DESC;

/**CREATE OR REPLACE
VIEW v_comentarioRecentes AS
SELECT COMENTARIOS FROM COMENTARIOS c, RECEITAS r
WHERE c.IDRECEITA = r.IDRECEITA
ORDER BY CREATED_AT DESC;*/

--------------------------------------------------
SEQUENCES
--------------------------------------------------
CREATE SEQUENCE idReceita MINVALUE 0 INCREMENT BY 1
	START WITH 0 CACHE 20 NOORDER NOCYCLE;
CREATE SEQUENCE idComentario MINVALUE 0 INCREMENT BY 1
	START WITH 0 CACHE 20 NOORDER NOCYCLE;
CREATE SEQUENCE idImagem MINVALUE 0 INCREMENT BY 1
	START WITH 0 CACHE 20 NOORDER NOCYCLE;

--------------------------------------------------
TRIGGER
--------------------------------------------------
create or replace TRIGGER trg_inserirCom
BEFORE INSERT ON COMENTARIOS
FOR EACH ROW
WHEN (NEW.IDCOMENTARIO IS NULL)
BEGIN
  SELECT IDCOMENTARIO.NEXTVAL INTO :NEW.IDCOMENTARIO FROM DUAL;
END;

create or replace TRIGGER trg_inserirImg
BEFORE INSERT ON IMAGENS
FOR EACH ROW
WHEN (NEW.IDIMAGEM IS NULL)
BEGIN
  SELECT IDIMAGEM.NEXTVAL INTO :NEW.IDIMAGEM FROM DUAL;
END;

create or replace TRIGGER trg_inserirRec
BEFORE INSERT ON RECEITAS
FOR EACH ROW
WHEN (NEW.IDRECEITA IS NULL)
BEGIN
  SELECT IDRECEITA.NEXTVAL INTO :NEW.IDRECEITA FROM DUAL;
END;

create or replace TRIGGER trg_inserirReceitaProp
AFTER INSERT ON RECEITAS
FOR EACH ROW
BEGIN
INSERT INTO RECEITASPROPRIAS (USERNAME,IDRECEITA) VALUES (:NEW.USERNAME,:NEW.IDRECEITA);
UPDATE UTILIZADORES SET NRRECEITAS = NRRECEITAS + 1 WHERE USERNAME = :NEW.USERNAME;
END;

create or replace TRIGGER trg_inserirValorAvaliacao
AFTER INSERT ON AVALIACAOUTILIZADOR
FOR EACH ROW
BEGIN
UPDATE RECEITAS SET NRAVALIACOES = NRAVALIACOES + 1 WHERE IDRECEITA = :NEW.IDRECEITA;
UPDATE RECEITAS SET VALORAVALIACOES = VALORAVALIACOES + :NEW.VALOR WHERE IDRECEITA = :NEW.IDRECEITA;
UPDATE UTILIZADORES SET NRAVALIACOES = NRAVALIACOES + 1 WHERE (SELECT USERNAME FROM RECEITAS WHERE IDRECEITA = :NEW.IDRECEITA) = UTILIZADORES.USERNAME;
UPDATE UTILIZADORES SET VALORAVALIACOES = VALORAVALIACOES + :NEW.VALOR WHERE (SELECT USERNAME FROM RECEITAS WHERE IDRECEITA = :NEW.IDRECEITA) = UTILIZADORES.USERNAME;
END;